name: Update Blockchain Dashboard

on:
  schedule:
    # 07:00 UTC = 08:00 CET / 09:00 CEST
    - cron: '0 7 * * *'
  workflow_dispatch:   # allow manual trigger from GitHub UI

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate dashboard HTML
        env:
          DUNE_API_KEY: ${{ secrets.DUNE_API_KEY }}
        run: python generate_dashboard.py

      - name: Upload to Azure Blob Storage
        env:
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          python - <<'PYEOF'
          import os
          from azure.storage.blob import BlobServiceClient, ContentSettings
          conn_str = os.environ["AZURE_STORAGE_CONNECTION_STRING"]
          client   = BlobServiceClient.from_connection_string(conn_str)
          blob     = client.get_blob_client(container="$web", blob="blockchain_dashboard.html")
          with open("blockchain_dashboard.html", "rb") as f:
              blob.upload_blob(
                  f,
                  overwrite=True,
                  content_settings=ContentSettings(content_type="text/html"),
              )
          print("Upload complete.")
          PYEOF
